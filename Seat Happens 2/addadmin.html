<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Admin - Ches Cafe</title>
  <link rel="stylesheet" href="adminlogin.css"> <!-- Reuse styles -->
</head>
<body>
  <div class="login-container">
    <h1>ADD NEW ADMIN</h1>
    <div id="error-message" class="error-message"></div>
    
    <form id="addAdminForm">
      <input type="email" id="newEmail" placeholder="New Admin Email" required>
      <input type="password" id="newPassword" placeholder="Password" required>
      <button type="submit">ADD ADMIN</button>
    </form>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';

    document.getElementById('addAdminForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('newEmail').value.trim();
      const password = document.getElementById('newPassword').value;
      const errorElement = document.getElementById('error-message');

      // TC14: Empty fields
      if (!email || !password) {
        errorElement.textContent = "Email and password are required.";
        return;
      }

      // TC15: Email validation
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        errorElement.textContent = "Invalid email format.";
        return;
      }

      // TC13: Password strength (8+ chars, upper/lower/special)
      if (!/(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*\W)/.test(password) || password.length < 8) {
        errorElement.textContent = "Password must be 8+ characters with uppercase, lowercase, and special characters.";
        return;
      }

      // TC11/TC12: Create admin
      const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
        email,
        password
      });

      if (signUpError) {
        errorElement.textContent = signUpError.message.includes("already") 
          ? "Email already in use." // TC12
          : "Error creating admin.";
        return;
      }

      // Assign admin role in profiles table
      const { error: profileError } = await supabase
        .from('profiles')
        .insert([{
          user_id: signUpData.user.id,
          email: email,
          role: 'admin'
        }]);

      if (profileError) {
        errorElement.textContent = "Error assigning admin role.";
      } else {
        alert("Admin added successfully!"); // TC11
        document.getElementById('addAdminForm').reset();
      }
    });
  </script>
</body>
</html>